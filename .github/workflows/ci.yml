name: Bookstore API CI/CD Pipeline

# Triggers:
# - On push or PR to main branch, runs smoke tests (quick health check).
# - On schedule (every night at 3:00 AM UTC), runs full regression suite.
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *'  # Runs every night at 3:00 AM UTC

jobs:
  # ---------------- SMOKE TEST JOB ----------------
  smoke:
    # Run this job only for push or PR events (NOT on schedule)
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: Smoke Tests

    steps:
      # Checks-out repository under $GITHUB_WORKSPACE
      - uses: actions/checkout@v4

      # Sets up Java 17 for Maven build
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Caches Maven dependencies to speed up builds
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Runs only SMOKE tests (fast, critical test cases)
      - name: Run SMOKE tests only
        run: mvn test -Dgroups="smoke" -Dallure.results.directory=target/allure-results

      # Uploads Allure test results as artifact for later reporting
      - name: Upload Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-smoke
          path: target/allure-results

  # ------------- REGRESSION TEST JOB (NIGHTLY) -------------
  regression:
    # Run this job only for scheduled nightly build
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    name: Nightly Regression Tests

    steps:
      # Checks-out repository under $GITHUB_WORKSPACE
      - uses: actions/checkout@v4

      # Sets up Java 17 for Maven build
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Caches Maven dependencies to speed up builds
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Runs full REGRESSION test suite (comprehensive coverage)
      - name: Run REGRESSION tests (all)
        run: mvn test -Dgroups="regression" -Dallure.results.directory=target/allure-results

      # Uploads Allure test results as artifact for later reporting
      - name: Upload Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-regression
          path: target/allure-results

# NOTES:
# - Smoke tests run for every push and PR to main for quick feedback on core functionality.
# - Regression tests run only at 3:00 AM UTC to avoid slowing down the main workflow, covering full test cases.
# - Allure results are uploaded for later reporting and analysis.